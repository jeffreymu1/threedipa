"""
Functions to guide user adjustment of the haploscope.
"""
from __future__ import annotations

import math
from typing import Dict, Tuple
import vizlab3d.config as config

def calc_display_positions(focal_distance: float) -> Tuple[float, float]:
    """Return the left/right display carriage positions for ``focal_distance``.

    Parameters
    ----------
    focal_distance:
        Requested distance from the mirrors to the focal plane in millimetres.

    Returns
    -------
    tuple
        (left_position, right_position) in the millimeters.
    """

    distance_change = abs(focal_distance) - config.MIN_FOCAL_DISTANCE
    left_pos = config.DISPLAY_LEFT_ZERO - distance_change
    right_pos = config.DISPLAY_RIGHT_ZERO + distance_change
    return left_pos, right_pos


def calc_eye_positions(iod: float) -> Tuple[float, float]:
    """Return mirror eye positions for a given interpupillary distance."""

    distance_change = (abs(iod) - config.MIN_IOD) / 2.0
    left_pos = config.EYE_LEFT_ZERO - distance_change
    right_pos = config.EYE_RIGHT_ZERO + distance_change
    return left_pos, right_pos


def calc_arm_rotations(iod: float, focal_distance: float) -> float:
    """Return the mirror arm rotation angle in degrees.
    """

    angle_rad = math.atan(0.5 * iod / focal_distance)
    return math.degrees(angle_rad)


def calc_physical_calibration(iod: float, focal_distance: float) -> Dict[str, float]:
    """Return a dict summarising all physical calibration values.
    """

    display_left, display_right = calc_display_positions(focal_distance)
    eye_left, eye_right = calc_eye_positions(iod)
    angle = calc_arm_rotations(iod, focal_distance)
    return {
        "DISPLAY_LEFT": display_left,
        "DISPLAY_RIGHT": display_right,
        "EYE_LEFT": eye_left,
        "EYE_RIGHT": eye_right,
        "ANGLE": angle,
    }
